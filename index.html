<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Avatar Battle Game</title>
<style>
  :root{
    --bg:#0f1116; --panel:#111726; --hudH:56px;
    --red:#ff3b5c; --blue:#3ba7ff;
    --vp:280px;
  }
  html,body{ margin:0; height:100%; background:var(--bg); color:#eaf0ff;
    font-family: ui-rounded,"SF Pro Rounded","PingFang SC","Segoe UI",system-ui,"Apple Color Emoji","Noto Color Emoji";
    overflow:hidden; }
  #wrap{ position:fixed; inset:0; display:grid; grid-template-rows:var(--hudH) 1fr;
    background: radial-gradient(1200px 600px at 30% -10%, #1a1f2b 5%, var(--bg) 55%); }

  /* HUD */
  #hud{ position:relative; display:flex; align-items:center; justify-content:space-between; padding:8px 10px;
    background:linear-gradient(180deg, rgba(20,24,34,.86), rgba(20,24,34,.55)); border-bottom:1px solid rgba(255,255,255,.06); backdrop-filter:blur(6px); }
  .team{ display:flex; flex-direction:column; gap:6px; min-width:140px; }
  .label{ display:flex; align-items:center; gap:8px; font-weight:800; font-size:13px; max-width:45vw; }
  .nameText{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .dot{ width:8px; height:8px; border-radius:50%; box-shadow:0 0 8px currentColor;}
  .bars{ display:flex; gap:3px; padding:2px; background:#0b1120; border:1px solid rgba(255,255,255,.06); border-radius:8px;}
  .bar{ width:14px; height:8px; border-radius:3px; background:#2a3142;}
  .bar.fill{ box-shadow:0 0 6px currentColor; }
  .red{ color:var(--red);} .blue{ color:var(--blue);}
  .avatarDot{ width:20px; height:20px; border-radius:50%; background:#222; background-size:cover; background-position:center; border:1px solid rgba(255,255,255,.12); }

  /* Timer */
  #timer{ position:absolute; left:50%; transform:translateX(-50%); top:8px;
    font-weight:900; letter-spacing:1px; font-size:14px; padding:4px 10px; border-radius:999px;
    background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.1); color:#e9f1ff; box-shadow:0 4px 14px rgba(0,0,0,.25); user-select:none; }

  /* Arena */
  #arena{ position:relative; overflow:hidden; }
  #c{ position:absolute; inset:0; width:100%; height:100%; touch-action:none; pointer-events:none; }

  /* Overlays */
  .overlay{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; z-index:20; }
  .panel{ background:var(--panel); border:1px solid rgba(255,255,255,.09); border-radius:16px; padding:16px; width:min(640px,92%); box-shadow:0 10px 30px rgba(0,0,0,.35); }

  /* Setup cards (vertical) */
  .choices{ display:grid; grid-template-columns:1fr; gap:14px;}
  .card{ position:relative; display:flex; flex-direction:column; gap:10px; align-items:center; padding:16px; border-radius:14px;
    background: radial-gradient(180px 100px at 50% 0, rgba(255,255,255,.08), rgba(255,255,255,.02)); border:1px solid rgba(255,255,255,.08); }
  .ring{ position:absolute; inset:10px; border:3px solid; border-radius:16px; filter:drop-shadow(0 0 8px currentColor); pointer-events:none;}
  .ring.red{ color:var(--red);} .ring.blue{ color:var(--blue);}
  .preview{ width:96px; height:96px; border-radius:50%; background:#0b0f19; border:2px dashed rgba(255,255,255,.18);
    background-size:cover; background-position:center; position:relative; }
  .upBtn{ margin-top:10px; font-size:12px; padding:6px 10px; border-radius:999px; background:#e9f0ff; color:#0c1224; font-weight:800; border:0; cursor:pointer; }
  .nameRow{ display:flex; gap:8px; width:100%; align-items:center; }
  .nameRow input{ flex:1; background:#0e1422; border:1px solid rgba(255,255,255,.12); color:#eaf0ff; border-radius:10px; padding:8px 10px; font-weight:700; }
  .nameRow .len{ font-size:11px; opacity:.7;}

  .actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:10px; }
  button{ appearance:none; border:0; border-radius:999px; padding:10px 14px; font-weight:800; cursor:pointer; background:#e9f0ff; color:#0c1224; }
  button.secondary{ background:#1a2131; color:#e9f0ff; border:1px solid rgba(255,255,255,.08); }

  /* Post result (简化，只展示胜者或平局) */
  .postBox{ display:flex; flex-direction:column; align-items:center; gap:14px; }
  .winnerAva{ width:104px; height:104px; border-radius:50%; background:#0b0f19; background-size:cover; background-position:center; border:2px solid rgba(255,255,255,.2); box-shadow:0 8px 26px rgba(0,0,0,.35); }
  .winnerName{ font-weight:900; font-size:18px; }
  .winnerTag{ font-weight:900; font-size:13px; padding:6px 12px; border-radius:999px; background:#11d39b; color:#06181a; }
  .tieTag{ background:#2a3142; color:#c7d2ff; }

  /* Cropper */
  #cropper .panel{ width:min(720px,94%); }
  .cropWrap{ display:grid; grid-template-columns:1fr 220px; gap:16px; align-items:center; }
  @media (max-width:640px){ .cropWrap{ grid-template-columns:1fr; } }
  .vpBox{ position:relative; width:var(--vp); height:var(--vp); margin:auto; border-radius:12px; overflow:hidden; background:#0b0f19; border:1px solid rgba(255,255,255,.12); }
  .vpBox img{ position:absolute; top:0; left:0; transform-origin:0 0; user-select:none; touch-action:none; }
  .mask:before{ content:""; position:absolute; inset:0; box-shadow:0 0 0 9999px rgba(0,0,0,.55) inset; pointer-events:none; }
  .grid{ position:absolute; inset:0; background:
      linear-gradient(0deg, transparent 49.5%, rgba(255,255,255,.12) 50%, transparent 50.5%),
      linear-gradient(90deg, transparent 49.5%, rgba(255,255,255,.12) 50%, transparent 50.5%); pointer-events:none; }
  .ctrlCol{ display:flex; flex-direction:column; gap:10px; }
  .hint{ font-size:12px; opacity:.8; }
  .range{ width:100%; }
  .cropActions{ display:flex; gap:10px; justify-content:flex-end; }

  /* Power button 修正遮罩溢出 */
  #powerBtn{
    position:absolute; left:50%; transform:translateX(-50%); bottom:12px; z-index:30;
    width:58px; height:58px; border-radius:50%;
    display:none; align-items:center; justify-content:center;
    font-weight:900; font-size:26px; background:#1b2336; color:#fff;
    border:2px solid rgba(255,255,255,.1); box-shadow:0 10px 24px rgba(0,0,0,.35);
    overflow:hidden; /* 关键：裁掉遮罩的方形边 */
  }
  #powerBtn.ready{ background:linear-gradient(180deg, #18e0a8, #18a0e0); }
  #powerBtn .icon{ position:relative; z-index:1; }
  #powerBtn .mask{
    position:absolute; inset:0; display:none; align-items:center; justify-content:center; border-radius:999px;
    background:rgba(8,10,18,.52); border:2px solid rgba(255,255,255,.22); backdrop-filter:blur(1px);
    pointer-events:none; z-index:3; box-sizing:border-box;
  }
  #powerBtn.lock .mask{ display:flex; }
  #powerBtn .mask .cdNum{ font-weight:900; font-size:16px; letter-spacing:.5px; text-shadow:0 2px 6px rgba(0,0,0,.6); }

  /* credit 右下 */
  #credit { position: fixed; right: 12px; bottom: 12px; z-index: 10000; padding: 6px 12px; border-radius: 999px;
    background: linear-gradient(180deg, rgba(26,33,49,.8), rgba(26,33,49,.6)); border: 1px solid rgba(255,255,255,.12);
    box-shadow: 0 6px 18px rgba(0,0,0,.35); font-size: 12px; line-height: 1; pointer-events: none; }
  #credit a{ pointer-events: auto; display: inline-flex; align-items: center; gap: 6px; color: #eaf2ff; text-decoration: none; opacity: .95; }
  #credit a::after{ content: "↗"; font-size: 11px; opacity: .8; }

  /* Emoji Version 左下 */
  #emojiLink { position: fixed; left: 12px; bottom: 12px; z-index: 10000; padding: 6px 12px; border-radius: 999px;
    background: linear-gradient(180deg, rgba(26,33,49,.8), rgba(26,33,49,.6)); border: 1px solid rgba(255,255,255,.12);
    box-shadow: 0 6px 18px rgba(0,0,0,.35); font-size: 12px; line-height: 1; pointer-events: none; }
  #emojiLink a{ pointer-events: auto; display: inline-flex; align-items: center; gap: 6px; color: #eaf2ff; text-decoration: none; opacity: .95; }
  #emojiLink a::after{ content: "↗"; font-size: 11px; opacity: .8; }
</style>
</head>
<body>
<div id="wrap">
  <!-- HUD -->
  <div id="hud">
    <div class="team">
      <div class="label">
        <span class="dot red" style="background:var(--red)"></span>
        <span id="lblRed" class="nameText">Red</span>
        <span id="dotRed" class="avatarDot"></span>
      </div>
      <div id="redBars" class="bars"></div>
    </div>
    <div id="timer">00:00</div>
    <div class="team" style="align-items:flex-end; text-align:right">
      <div class="label" style="justify-content:flex-end">
        <span id="dotBlue" class="avatarDot"></span>
        <span id="lblBlue" class="nameText">Blue</span>
        <span class="dot blue" style="background:var(--blue)"></span>
      </div>
      <div id="blueBars" class="bars"></div>
    </div>
  </div>

  <!-- Arena -->
  <div id="arena">
    <canvas id="c"></canvas>

    <!-- Setup -->
    <div id="setup" class="overlay">
      <div class="panel">
        <div class="choices">
          <div class="card" id="cardRed">
            <div class="ring red"></div>
            <div class="preview" id="prevRed"></div>
            <input id="fileRed" type="file" accept="image/*" hidden>
            <button class="upBtn" id="btnRed"></button>
            <div class="nameRow">
              <input id="nameRed" type="text" maxlength="10">
              <span class="len" id="lenRed">0/10</span>
            </div>
          </div>
          <div class="card" id="cardBlue">
            <div class="ring blue"></div>
            <div class="preview" id="prevBlue"></div>
            <input id="fileBlue" type="file" accept="image/*" hidden>
            <button class="upBtn" id="btnBlue"></button>
            <div class="nameRow">
              <input id="nameBlue" type="text" maxlength="10">
              <span class="len" id="lenBlue">0/10</span>
            </div>
          </div>
        </div>
        <div class="actions">
          <button id="btnClear" class="secondary" type="button"></button>
          <button id="btnStart" type="button" disabled></button>
        </div>
      </div>
    </div>

    <!-- Post（简化版） -->
    <div id="post" class="overlay" style="display:none">
      <div class="panel">
        <div class="postBox">
          <div id="postAva" class="winnerAva"></div>
          <div id="postName" class="winnerName">—</div>
          <div id="postTag" class="winnerTag">WIN</div>
        </div>
        <div class="actions" style="justify-content:space-between; margin-top:16px;">
          <button id="btnBack" class="secondary" type="button"></button>
          <button id="btnAgain" type="button"></button>
        </div>
      </div>
    </div>

    <!-- Cropper -->
    <div id="cropper" class="overlay" style="display:none">
      <div class="panel">
        <div class="cropWrap">
          <div class="vpBox mask" id="vpBox">
            <img id="cropImg" alt="crop">
            <div class="grid"></div>
          </div>
          <div class="ctrlCol">
            <div id="cropHint" class="hint"></div>
            <input id="zoomRange" class="range" type="range" min="100" max="300" step="1" value="100">
            <div class="cropActions">
              <button id="cropCancel" class="secondary" type="button"></button>
              <button id="cropOk" type="button"></button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Power -->
    <div id="powerBtn"><span class="icon">❔</span><div class="mask"><span class="cdNum">10</span></div></div>
  </div>
</div>

<!-- Left/Right bottom links -->
<div id="emojiLink"><a href="https://childweii.github.io/Avatar-Battle-Game/" target="_blank" rel="noopener">From Childwei.</a></div>
<div id="credit"><a href="https://gexyi.com" target="_blank" rel="noopener">Ge Yi</a></div>
<script>
;(() => {
  /* ===== i18n：按系统语言 ===== */
  const isZH = /^zh/i.test(navigator.language||"");
  document.documentElement.lang = isZH ? 'zh-CN' : 'en';
  const STR = isZH ? {
    title:'头像对战',
    red:'红方', blue:'蓝方',
    start:'开始', clear:'清空', again:'再来一局', back:'返回设置',
    upload:'上传头像', namePH_R:'红方名称（≤10）', namePH_B:'蓝方名称（≤10）',
    win:'胜利', lose:'失败', tie:'平局',
    cropHint:'拖动图片调整位置，使用滚轮或滑条缩放',
    cropCancel:'取消', cropOk:'确定'
  } : {
    title:'Avatar Battle Game',
    red:'Red', blue:'Blue',
    start:'Start', clear:'Clear', again:'Play Again', back:'Back',
    upload:'Upload Avatar', namePH_R:'Red name (≤10)', namePH_B:'Blue name (≤10)',
    win:'WIN', lose:'LOSE', tie:'TIE',
    cropHint:'Drag to move, use wheel or slider to zoom',
    cropCancel:'Cancel', cropOk:'OK'
  };
  document.title = STR.title;

  /* ===== DOM ===== */
  const $ = s => document.querySelector(s);
  const canvas=$('#c'), ctx=canvas.getContext('2d'), arena=$('#arena');
  const lblRed=$('#lblRed'), lblBlue=$('#lblBlue');
  const dotRed=$('#dotRed'), dotBlue=$('#dotBlue');
  const nameRed=$('#nameRed'), nameBlue=$('#nameBlue'), lenRed=$('#lenRed'), lenBlue=$('#lenBlue');
  const fileRed=$('#fileRed'), fileBlue=$('#fileBlue'), prevRed=$('#prevRed'), prevBlue=$('#prevBlue');
  const btnRed=$('#btnRed'), btnBlue=$('#btnBlue'), btnStart=$('#btnStart'), btnClear=$('#btnClear'), btnAgain=$('#btnAgain'), btnBack=$('#btnBack');
  const setup=$('#setup'), post=$('#post'), timerEl=$('#timer');
  const postAva=$('#postAva'), postName=$('#postName'), postTag=$('#postTag');
  const powerBtn=$('#powerBtn'), iconSpan=powerBtn.querySelector('.icon'), cdMask=powerBtn.querySelector('.mask'), cdNum=powerBtn.querySelector('.cdNum');

  // 文案
  btnRed.textContent = STR.upload; btnBlue.textContent = STR.upload;
  nameRed.placeholder = STR.namePH_R; nameBlue.placeholder = STR.namePH_B;
  btnStart.textContent = STR.start; btnClear.textContent = STR.clear;
  btnAgain.textContent = STR.again; btnBack.textContent = STR.back;
  lblRed.textContent = STR.red; lblBlue.textContent = STR.blue;
  $('#cropHint').textContent=STR.cropHint; $('#cropCancel').textContent=STR.cropCancel; $('#cropOk').textContent=STR.cropOk;

  /* ===== util ===== */
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const DPR=Math.max(1,Math.min(2,window.devicePixelRatio||1));
  const EMOJI_FONT='"Apple Color Emoji","Noto Color Emoji","Segoe UI Emoji",system-ui';
  function resize(){ const r=arena.getBoundingClientRect(); canvas.width=Math.floor(r.width*DPR); canvas.height=Math.floor(r.height*DPR); canvas.style.width=r.width+'px'; canvas.style.height=r.height+'px'; ctx.setTransform(DPR,0,0,DPR,0,0); W=r.width; H=r.height; }
  let W=0,H=0; resize(); window.addEventListener('resize',resize); window.addEventListener('orientationchange',()=>setTimeout(resize,200));
  const CTRL_H=64;
  function baseRect(){ const m=clamp(Math.round(Math.min(W,H)*0.06),12,28); return {x:m,y:m,w:Math.max(120,W-2*m),h:Math.max(120,H-2*m-CTRL_H)};}
  let fieldScale=1, shrinkTimeline=null;
  function curRect(){ const b=baseRect(), s=fieldScale; const w=b.w*s, h=b.h*s, x=b.x+(b.w-w)/2, y=b.y+(b.h-h)/2; return {x,y,w,h}; }
  function drawField(){ const r=curRect(); ctx.save(); const g=ctx.createLinearGradient(r.x,r.y,r.x+r.w,r.y+r.h); g.addColorStop(0,'rgba(0,220,200,.55)'); g.addColorStop(1,'rgba(120,200,255,.55)'); ctx.strokeStyle=g; ctx.lineWidth=3; ctx.shadowBlur=12; ctx.shadowColor='#34ffd0'; ctx.strokeRect(r.x,r.y,r.w,r.h); ctx.restore(); }
  function updateShrink(t){ if(!shrinkTimeline) return; const {t0,t1,t2,t3,from,to}=shrinkTimeline; if(t<=t1){ fieldScale=from+(to-from)*((t-t0)/(t1-t0)); } else if(t<=t2){ fieldScale=to; } else if(t<=t3){ fieldScale=to+(1-to)*((t-t2)/(t3-t2)); } else { fieldScale=1; shrinkTimeline=null; } }
  const fmt=t=>{ const m=Math.floor(t/60), s=Math.floor(t%60); return (m<10?'0':'')+m+':' + (s<10?'0':'')+s; };

  /* ===== Game state ===== */
  const Game = { inPlay:false, t0:0, last:performance.now(), red:null, blue:null, items:[], fx:[], nextGear:0, nextHeart:0, powerReady:true, powerCD:10, cdLeft:0 };
  const RED_C=getComputedStyle(document.documentElement).getPropertyValue('--red').trim();
  const BLUE_C=getComputedStyle(document.documentElement).getPropertyValue('--blue').trim();
  function setBars(el,hp,color){ el.innerHTML=''; for(let i=0;i<10;i++){ const b=document.createElement('div'); b.className='bar'+(i<hp?' fill':''); if(i<hp){ b.style.color=color; b.style.background=color; } el.appendChild(b);} }
  function refreshHUD(){ setBars($('#redBars'), Game.red?Game.red.hp:10, RED_C); setBars($('#blueBars'), Game.blue?Game.blue.hp:10, BLUE_C); lblRed.textContent = Game.red?Game.red.name:(nameRed.value.trim()||STR.red); lblBlue.textContent = Game.blue?Game.blue.name:(nameBlue.value.trim()||STR.blue); }

  /* ===== Upload + Crop ===== */
  const Crop = { which:null, imgObj:null, iw:0, ih:0, vp:0, s0:1, scale:1, tx:0, ty:0, dragging:false, lastX:0, lastY:0 };
  const vpBox=$('#vpBox'), cropImg=$('#cropImg'), zoomRange=$('#zoomRange'), cropper=$('#cropper');
  function loadFile(file){ return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(file); }); }
  function openCropper(which, dataURL){ Crop.which=which; cropImg.src=dataURL; cropImg.onload=()=>{ Crop.imgObj=cropImg; Crop.iw=cropImg.naturalWidth||cropImg.width; Crop.ih=cropImg.naturalHeight||cropImg.height; Crop.vp=parseInt(getComputedStyle(vpBox).getPropertyValue('width')); const sX=Crop.vp/Crop.iw, sY=Crop.vp/Crop.ih; Crop.s0=Math.max(sX,sY); Crop.scale=Crop.s0; Crop.tx=(Crop.vp-Crop.iw*Crop.scale)/2; Crop.ty=(Crop.vp-Crop.ih*Crop.scale)/2; applyTransform(); zoomRange.value=100; cropper.style.display='flex'; }; }
  function applyTransform(){ cropImg.style.transform=`translate(${Crop.tx}px, ${Crop.ty}px) scale(${Crop.scale})`; }
  function clampPan(){ const w=Crop.iw*Crop.scale, h=Crop.ih*Crop.scale, vp=Crop.vp; if(w<=vp){ Crop.tx=(vp-w)/2; } else { Crop.tx=clamp(Crop.tx, vp-w, 0); } if(h<=vp){ Crop.ty=(vp-h)/2; } else { Crop.ty=clamp(Crop.ty, vp-h, 0); } }
  function setScaleAround(newScale,cx,cy){ const old=Crop.scale; newScale=Math.max(Crop.s0, Math.min(Crop.s0*3, newScale)); const ix=(cx-Crop.tx)/old, iy=(cy-Crop.ty)/old; Crop.tx=cx-ix*newScale; Crop.ty=cy-iy*newScale; Crop.scale=newScale; clampPan(); applyTransform(); }
  vpBox.addEventListener('pointerdown', e=>{ Crop.dragging=true; Crop.lastX=e.clientX; Crop.lastY=e.clientY; vpBox.setPointerCapture(e.pointerId); });
  vpBox.addEventListener('pointermove', e=>{ if(!Crop.dragging) return; const dx=e.clientX-Crop.lastX, dy=e.clientY-Crop.lastY; Crop.tx+=dx; Crop.ty+=dy; Crop.lastX=e.clientX; Crop.lastY=e.clientY; clampPan(); applyTransform(); });
  vpBox.addEventListener('pointerup', ()=>{ Crop.dragging=false; });
  vpBox.addEventListener('pointercancel', ()=>{ Crop.dragging=false; });
  vpBox.addEventListener('wheel', e=>{ e.preventDefault(); const rect=vpBox.getBoundingClientRect(); const cx=e.clientX-rect.left, cy=e.clientY-rect.top; setScaleAround(Crop.scale*(e.deltaY<0?1.08:0.92), cx, cy); zoomRange.value=Math.round(100*(Crop.scale/Crop.s0)); }, {passive:false});
  zoomRange.addEventListener('input', ()=>{ const rect=vpBox.getBoundingClientRect(); setScaleAround(Crop.s0*(zoomRange.value/100), rect.width/2, rect.height/2); });
  $('#cropCancel').addEventListener('click', ()=>{ cropper.style.display='none'; });
  $('#cropOk').addEventListener('click', ()=>{ const vp=Crop.vp; const sx=Math.max(0, (-Crop.tx)/Crop.scale); const sy=Math.max(0, (-Crop.ty)/Crop.scale); const sw=Math.min(Crop.iw, vp/Crop.scale); const sh=Math.min(Crop.ih, vp/Crop.scale); const out=512; const cv=document.createElement('canvas'); cv.width=out; cv.height=out; const c=cv.getContext('2d'); c.imageSmoothingQuality='high'; c.drawImage(Crop.imgObj, sx, sy, sw, sh, 0,0,out,out); const dataURL=cv.toDataURL('image/png', 0.92); setPreview(Crop.which, dataURL); cropper.style.display='none'; });
  function setPreview(which,dataURL){ const img=new Image(); img.src=dataURL; img.onload=()=>{ if(which==='red'){ prevRed.style.backgroundImage=`url(${dataURL})`; dotRed.style.backgroundImage=`url(${dataURL})`; redSrc={img,url:dataURL}; } else { prevBlue.style.backgroundImage=`url(${dataURL})`; dotBlue.style.backgroundImage=`url(${dataURL})`; blueSrc={img,url:dataURL}; } validateStart(); }; }
  btnRed.addEventListener('click', ()=>fileRed.click()); btnBlue.addEventListener('click', ()=>fileBlue.click());
  fileRed.addEventListener('change', async e=>{ const f=e.target.files[0]; if(!f) return; openCropper('red', await loadFile(f)); e.target.value=''; });
  fileBlue.addEventListener('change', async e=>{ const f=e.target.files[0]; if(!f) return; openCropper('blue', await loadFile(f)); e.target.value=''; });

  nameRed.addEventListener('input', ()=>{ lenRed.textContent=`${nameRed.value.trim().length}/10`; refreshHUD(); });
  nameBlue.addEventListener('input', ()=>{ lenBlue.textContent=`${nameBlue.value.trim().length}/10`; refreshHUD(); });

  let redSrc=null, blueSrc=null;
  function validateStart(){ btnStart.disabled = !(redSrc && blueSrc); }

  btnClear.addEventListener('click', ()=>{ redSrc=blueSrc=null; prevRed.style.backgroundImage=''; prevBlue.style.backgroundImage=''; dotRed.style.backgroundImage=''; dotBlue.style.backgroundImage=''; nameRed.value=''; nameBlue.value=''; lenRed.textContent='0/10'; lenBlue.textContent='0/10'; refreshHUD(); validateStart(); });

  /* ===== Rules ===== */
  const BASE_SPEED=180, nowT=()=>performance.now();
  function rotate(vx,vy,deg){ const a=deg*Math.PI/180, c=Math.cos(a), s=Math.sin(a); return {vx:vx*c - vy*s, vy:vx*s + vy*c}; }
  const hitR = p => p.r + 10;
  const isHidden = p => nowT()<p.holeEnd;
  function wallBounce(p){ const r=curRect(), R=hitR(p); if(p.x-R<r.x){p.x=r.x+R; p.vx=Math.abs(p.vx);} if(p.x+R>r.x+r.w){p.x=r.x+r.w-R; p.vx=-Math.abs(p.vx);} if(p.y-R<r.y){p.y=r.y+R; p.vy=Math.abs(p.vy);} if(p.y+R>r.y+r.h){p.y=r.y+r.h-R; p.vy=-Math.abs(p.vy);} }
  function speedMult(p){ return (nowT()<p.speedUpEnd?2:1) * (nowT()<p.speedDownEnd?0.5:1); }
  function mkPlayer(x,y,color,avatarImg,name){ const a=Math.random()*Math.PI*2; return { x,y, vx:Math.cos(a)*BASE_SPEED, vy:Math.sin(a)*BASE_SPEED, r:Math.min(42,Math.max(30,Math.min(W,H)*0.05)), color, avatar:avatarImg, name, hp:10, saw:false, shieldEnd:0, speedUpEnd:0, speedDownEnd:0, weakEnd:0, frozenEnd:0, star:0, hitCdEnd:0, steerT:0, holeEnd:0, holeX:0, holeY:0, holeKick:0, reflectEnd:0 }; }
  function checkHoleExit(p){ if(p.holeKick && nowT()>=p.holeEnd){ const a=Math.random()*Math.PI*2; const v=BASE_SPEED*(1.1+Math.random()*0.4); p.vx=Math.cos(a)*v; p.vy=Math.sin(a)*v; p.steerT=0.4+Math.random()*0.6; p.holeKick=0; Game.fx.push({type:'poof', x:p.x, y:p.y, t0:nowT(), dur:420}); } }
  function stepPlayer(p,dt){ if(isHidden(p)){ p.x=p.holeX; p.y=p.holeY; return; } if(nowT()<p.frozenEnd){ wallBounce(p); return; } p.steerT-=dt; if(p.steerT<=0){ p.steerT=0.9+Math.random()*0.6; const rot=rotate(p.vx,p.vy,(Math.random()*2-1)*9); p.vx=rot.vx; p.vy=rot.vy; } const m=speedMult(p); p.x+=p.vx*dt*m; p.y+=p.vy*dt*m; wallBounce(p); }
  function collideBalls(a,b){ if(isHidden(a)||isHidden(b)) return; const dx=b.x-a.x, dy=b.y-a.y, d=Math.hypot(dx,dy), minD=hitR(a)+hitR(b); if(d<minD){ const nx=dx/(d||1), ny=dy/(d||1), overlap=minD-d; a.x-=nx*overlap/2; a.y-=ny*overlap/2; b.x+=nx*overlap/2; b.y+=ny*overlap/2; const tx=-ny, ty=nx, an=a.vx*nx+a.vy*ny, bn=b.vx*nx+b.vy*ny, at=a.vx*tx+a.vy*ty, bt=b.vx*tx+a.vy*ty; a.vx=bn*nx+at*tx; a.vy=bn*ny+at*ty; b.vx=an*nx+bt*tx; b.vy=an*ny+bt*ty; if(nowT()>a.hitCdEnd && nowT()>b.hitCdEnd){ let dmgA=0,dmgB=0; if(a.saw){ dmgB=1 + (a.star>0?1:0) + (nowT()<b.weakEnd?1:0); if(nowT()<b.shieldEnd) dmgB=0; if(a.star>0) a.star--; a.saw=false; } if(b.saw){ dmgA=1 + (b.star>0?1:0) + (nowT()<a.weakEnd?1:0); if(nowT()<a.shieldEnd) dmgA=0; if(b.star>0) b.star--; b.saw=false; } if(dmgA||dmgB){ const refA=nowT()<a.reflectEnd, refB=nowT()<b.reflectEnd; let deltaA=0, deltaB=0; if(refA && dmgA>0){ deltaB+=dmgA*2; dmgA=0; } if(refB && dmgB>0){ deltaA+=dmgB*2; dmgB=0; } deltaA+=dmgA; deltaB+=dmgB; a.hp=Math.max(0,a.hp-deltaA); b.hp=Math.max(0,b.hp-deltaB); a.hitCdEnd=b.hitCdEnd=nowT()+420; } } } }

  /* ===== Visuals ===== */
  function ring(x,y,r,c){ ctx.save(); ctx.beginPath(); ctx.arc(x,y,r+10,0,Math.PI*2); ctx.strokeStyle=c; ctx.lineWidth=6; ctx.shadowBlur=18; ctx.shadowColor=c; ctx.stroke(); ctx.restore(); }
  function dashed(x,y,r,c){ ctx.save(); ctx.setLineDash([8,8]); ctx.beginPath(); ctx.arc(x,y,r+14,0,Math.PI*2); ctx.strokeStyle=c; ctx.lineWidth=3; ctx.shadowBlur=12; ctx.shadowColor=c; ctx.stroke(); ctx.setLineDash([]); ctx.restore(); }
  function speedFx(p){ if(nowT()<p.speedUpEnd){ const a=Math.atan2(p.vy,p.vx), len=p.r*1.2; ctx.save(); ctx.globalAlpha=.9; ctx.lineWidth=3; ctx.strokeStyle='#b8f4ff'; for(let i=0;i<4;i++){ const k=a+(i-1.5)*.14; ctx.beginPath(); ctx.moveTo(p.x-Math.cos(k)*p.r, p.y-Math.sin(k)*p.r); ctx.lineTo(p.x-Math.cos(k)*(p.r+len), p.y-Math.sin(k)*(p.r+len)); ctx.stroke(); } ctx.restore(); } if(nowT()<p.speedDownEnd){ ctx.save(); ctx.globalAlpha=.4; ctx.strokeStyle='#a0a7b8'; ctx.setLineDash([4,6]); ctx.lineWidth=4; ctx.beginPath(); ctx.arc(p.x,p.y,p.r+18,0,Math.PI*2); ctx.stroke(); ctx.setLineDash([]); ctx.restore(); } }
  function weakFx(p){ if(nowT()<p.weakEnd){ ctx.save(); ctx.globalAlpha=.5; ctx.strokeStyle='#3b2b3b'; ctx.lineWidth=5; ctx.setLineDash([2,10]); ctx.beginPath(); ctx.arc(p.x,p.y,p.r+22,0,Math.PI*2); ctx.stroke(); ctx.setLineDash([]); ctx.restore(); } }
  function freezeFx(p){ if(nowT()<p.frozenEnd){ ctx.save(); ctx.globalAlpha=.85; ctx.font=(p.r*1.2)+'px '+EMOJI_FONT; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText('❄️',p.x,p.y+2); ctx.restore(); } }
  function starFx(p){ if(p.star>0){ ctx.save(); ctx.globalAlpha=.9; ctx.font=(p.r*0.9)+'px '+EMOJI_FONT; ctx.textAlign='left'; ctx.textBaseline='top'; ctx.fillText('✨', p.x+p.r+14, p.y-p.r-6); ctx.restore(); } }
  function reflectFx(p){ if(nowT()<p.reflectEnd){ dashed(p.x,p.y,p.r,'#ff3b5c'); } }
  function sawFx(x,y,r){ ctx.save(); ctx.translate(x,y); ctx.beginPath(); const n=18; for(let i=0;i<=n;i++){ const a=i/n*Math.PI*2; const rr=i%2===0?r+14:r+6; ctx.lineTo(Math.cos(a)*rr, Math.sin(a)*rr); } ctx.closePath(); ctx.strokeStyle='#cfd6e6'; ctx.lineWidth=2.5; ctx.fillStyle='#8e99ae22'; ctx.fill(); ctx.shadowBlur=8; ctx.shadowColor='#cfd6e6'; ctx.stroke(); ctx.restore(); }
  function drawAvatar(x,y,r,img){ ctx.save(); ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.closePath(); ctx.clip(); if(img&&img.complete){ const d=r*2; const iw=img.naturalWidth||img.width, ih=img.naturalHeight||img.height; const s=Math.max(d/iw, d/ih), sw=iw*s, sh=ih*s; ctx.drawImage(img, (d-sw)/2 + (x-r), (d-sh)/2 + (y-r), sw, sh); } else { ctx.fillStyle='#1a2131'; ctx.fillRect(x-r,y-r,r*2,r*2); } ctx.restore(); }
  function holeFx(p){ const k=0.5+0.5*Math.sin(nowT()/200); const x=p.holeX, y=p.holeY, r=p.r*(0.95+0.08*k); ctx.save(); const g=ctx.createRadialGradient(x,y,2, x,y,r+18); g.addColorStop(0,'#0b0e16'); g.addColorStop(1,'rgba(0,0,0,0)'); ctx.fillStyle=g; ctx.beginPath(); ctx.arc(x,y,r+18,0,Math.PI*2); ctx.fill(); ctx.globalAlpha=0.8; ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.strokeStyle='rgba(40,46,66,.9)'; ctx.lineWidth=6; ctx.stroke(); ctx.restore(); }

  /* ===== Items ===== */
  const ItemType={ Gear:'gear', Heart:'heart', Shield:'shield', SpeedUp:'speedup', SlowDown:'slowdown', Break:'break', Star:'star', Weaken:'weaken', Freeze:'freeze', Swap:'swap', Bomb:'bomb', Blast:'blast', FullHeal:'fullheal', Skull:'skull', Beer:'beer', Hole:'hole', Chili:'chili' };
  function randInPlay(r){ const pr=curRect(); return { x:pr.x+r+Math.random()*(pr.w-2*r), y:pr.y+r+Math.random()*(pr.h-2*r) }; }
  function spawn(type,ttl){ const r=20, p=randInPlay(r); const it={id:Math.random().toString(36).slice(2), type, x:p.x, y:p.y, r, ttl, alive:true}; Game.items.push(it); return it; }
  function schedule(type,base=1500,rand=2500){ const t=nowT()+base+Math.random()*rand; if(type===ItemType.Gear) Game.nextGear=t; else if(type===ItemType.Heart) Game.nextHeart=t; }
  function updateItems(dt){ const t=nowT(); if(t>=Game.nextGear && !Game.items.some(i=>i.alive&&i.type===ItemType.Gear)) spawn(ItemType.Gear,12), schedule(ItemType.Gear); if(t>=Game.nextHeart && !Game.items.some(i=>i.alive&&i.type===ItemType.Heart)) spawn(ItemType.Heart,10), schedule(ItemType.Heart); for(const it of Game.items){ if(!it.alive) continue; it.ttl-=dt; if(it.ttl<=0){ it.alive=false; if(it.type===ItemType.Gear) schedule(ItemType.Gear); if(it.type===ItemType.Heart) schedule(ItemType.Heart); } } for(let i=Game.items.length-1;i>=0;i--) if(!Game.items[i].alive) Game.items.splice(i,1); }
  function drawItem(it){ let face; if(it.type==='gear') face='⚙️'; else if(it.type==='heart') face='♥️'; else if(it.type==='shield') face='🛡️'; else if(it.type==='speedup') face='⏩'; else if(it.type==='slowdown') face='⏪'; else if(it.type==='break') face='💔'; else if(it.type==='star') face='⭐'; else if(it.type==='weaken') face='🖤'; else if(it.type==='freeze') face='❄️'; else if(it.type==='swap') face='🔄'; else if(it.type==='blast') face='💥'; else if(it.type==='fullheal') face='💓'; else if(it.type==='skull') face='☠️'; else if(it.type==='beer') face='🍻'; else if(it.type==='hole') face='🕳️'; else if(it.type==='chili') face='🌶️'; ctx.save(); ctx.globalAlpha=0.86+0.14*Math.sin(nowT()/220); ctx.font=(it.r*1.6)+'px '+EMOJI_FONT; ctx.textAlign='center'; ctx.textBaseline='middle'; if(face) ctx.fillText(face,it.x,it.y+2); if(it.type==='blast'){ const k=0.5+0.5*Math.sin(nowT()/180); ctx.globalAlpha=0.25; ctx.beginPath(); ctx.arc(it.x,it.y,(it.hzR||74)*(0.95+0.1*k),0,Math.PI*2); ctx.strokeStyle='#ff9b7a'; ctx.lineWidth=3; ctx.stroke(); } ctx.restore(); }
  function isOffensiveType(t){ return t===ItemType.Gear || t===ItemType.Break || t===ItemType.Star || t===ItemType.Weaken; }
  function tryPickup(p,it){
    if(!it.alive || isHidden(p)) return;
    if(it.type===ItemType.Blast){ const d0=Math.hypot(p.x-it.x,p.y-it.y); const R=(it.hzR||74)+hitR(p); if(d0<=R) explode(it); return; }
    const d=Math.hypot(p.x-it.x,p.y-it.y);
    if(d < hitR(p) + it.r - 6){
      const reflectOn = nowT()<p.reflectEnd;
      if(it.type===ItemType.Chili){ p.reflectEnd = nowT()+10000; p.saw=false; p.star=0; }
      else if(reflectOn && isOffensiveType(it.type)){ /* ignore offensive while reflect */ }
      else if(it.type===ItemType.Gear){ p.saw=true; }
      else if(it.type===ItemType.Heart){ if(p.hp<10) p.hp++; }
      else if(it.type===ItemType.Shield){ p.shieldEnd = nowT()+10000; }
      else if(it.type===ItemType.SpeedUp){ p.speedUpEnd = nowT()+10000; }
      else if(it.type===ItemType.SlowDown){ p.speedDownEnd = nowT()+5000; }
      else if(it.type===ItemType.Break){ const other=p===Game.red?Game.blue:Game.red; if(reflectOn){ other.hp=Math.max(0, other.hp-2); } else { p.hp=Math.max(0,p.hp-1); } }
      else if(it.type===ItemType.Star){ p.star = Math.min(99,p.star+1); }
      else if(it.type===ItemType.Weaken){ p.weakEnd = nowT()+10000; }
      else if(it.type===ItemType.Freeze){ p.frozenEnd = nowT()+5000; }
      else if(it.type===ItemType.Swap){ const other=p===Game.red?Game.blue:Game.red; const tx=p.x, ty=p.y; p.x=other.x; p.y=other.y; other.x=tx; other.y=ty; }
      else if(it.type===ItemType.FullHeal){ p.hp=10; }
      else if(it.type===ItemType.Skull){ if(p.hp>3){ p.hp=3; } Game.fx.push({type:'skull', x:p.x, y:p.y, t0:nowT(), dur:600}); }
      else if(it.type===ItemType.Beer){ const other=p===Game.red?Game.blue:Game.red; const tmp=p.hp; p.hp=other.hp; other.hp=tmp; }
      else if(it.type===ItemType.Hole){ p.hp=5; p.holeX=p.x; p.holeY=p.y; p.holeEnd=nowT()+10000; p.vx=0; p.vy=0; p.holeKick=1; Game.fx.push({type:'poof', x:p.x, y:p.y, t0:nowT(), dur:700}); }
      it.alive=false; if(it.type===ItemType.Gear) schedule(ItemType.Gear,1500,2500); if(it.type===ItemType.Heart) schedule(ItemType.Heart,1500,2500);
    }
  }
  function explode(blast){
    if(!blast.alive) return; blast.alive=false;
    const R=blast.hzR||74;
    const dR=Math.hypot(Game.red.x-blast.x, Game.red.y-blast.y);
    const dB=Math.hypot(Game.blue.x-blast.x, Game.blue.y-blast.y);
    const hitRed = dR <= R + hitR(Game.red);
    const hitBlue = dB <= R + hitR(Game.blue);
    const dmgRed = Math.ceil(Game.red.hp/2);
    const dmgBlue = Math.ceil(Game.blue.hp/2);
    if(hitRed && !isHidden(Game.red)){ if(nowT()<Game.red.reflectEnd){ Game.blue.hp = Math.max(0, Game.blue.hp - dmgRed*2); } else { Game.red.hp = Math.max(0, Game.red.hp - dmgRed); } }
    if(hitBlue && !isHidden(Game.blue)){ if(nowT()<Game.blue.reflectEnd){ Game.red.hp = Math.max(0, Game.red.hp - dmgBlue*2); } else { Game.blue.hp = Math.max(0, Game.blue.hp - dmgBlue); } }
    Game.fx.push({type:'ring', x:blast.x, y:blast.y, t0:nowT(), dur:450, r0:10, r1:R+28});
  }
  function drawFx(){ const t=nowT(); for(let i=Game.fx.length-1;i>=0;i--){ const f=Game.fx[i], k=(t-f.t0)/f.dur; if(k>=1){ Game.fx.splice(i,1); continue; } if(f.type==='ring'){ const r=f.r0+(f.r1-f.r0)*k; ctx.save(); ctx.globalAlpha=0.35*(1-k); ctx.beginPath(); ctx.arc(f.x,f.y,r,0,Math.PI*2); ctx.strokeStyle='#ffcf7a'; ctx.lineWidth=6; ctx.stroke(); ctx.restore(); } else if(f.type==='skull'){ const r=18+90*k; ctx.save(); ctx.globalAlpha=0.55*(1-k); ctx.beginPath(); ctx.arc(f.x,f.y,r,0,Math.PI*2); ctx.strokeStyle='#a7adbb'; ctx.lineWidth=4; ctx.setLineDash([6,10]); ctx.stroke(); ctx.setLineDash([]); ctx.font=(22+16*k)+'px '+EMOJI_FONT; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText('☠️', f.x, f.y+1); ctx.restore(); } else if(f.type==='poof'){ const r=8+120*k; ctx.save(); ctx.globalAlpha=0.5*(1-k); ctx.beginPath(); ctx.arc(f.x,f.y,r,0,Math.PI*2); ctx.strokeStyle='rgba(80,90,120,.8)'; ctx.lineWidth=6; ctx.stroke(); ctx.restore(); } } }

  /* ===== Power button ===== */
  function setPowerReady(v){ Game.powerReady=v; powerBtn.classList.toggle('ready',v); powerBtn.classList.toggle('lock',!v); cdMask.style.display = v ? 'none' : 'flex'; if(v) iconSpan.textContent='❔'; }
  function resetPower(){ Game.cdLeft=Game.powerCD; setPowerReady(false); }
  function updatePower(dt){ if(!Game.powerReady){ Game.cdLeft-=dt; if(Game.cdLeft<=0){ setPowerReady(true); } else { cdNum.textContent=Math.ceil(Game.cdLeft); } } }
  function triggerShrink(){ const t=performance.now(), from=fieldScale, to=0.75; shrinkTimeline={ t0:t, t1:t+5000, t2:t+9000, t3:t+10000, from, to }; }
  function spawnBlast(ttl=4, hzR=74){ const r=20, pos=randInPlay(r); const it={id:Math.random().toString(36).slice(2), type:ItemType.Blast, x:pos.x, y:pos.y, r, ttl, alive:true, hzR}; Game.items.push(it); return it; }
  function triggerBombSingle(){ spawnBlast(10,74); }
  const bag=[ {k:'shield',e:'🛡️',kind:'spawn'},{k:'speedup',e:'⏩',kind:'spawn'},{k:'slowdown',e:'⏪',kind:'spawn'},{k:'break',e:'💔',kind:'spawn'},{k:'star',e:'⭐',kind:'spawn'},{k:'weaken',e:'🖤',kind:'spawn'},{k:'freeze',e:'❄️',kind:'spawn'},{k:'swap',e:'🔄',kind:'spawn'},{k:'bomb',e:'💣',kind:'instant'},{k:'fullheal',e:'💓',kind:'spawn'},{k:'skull',e:'☠️',kind:'spawn'},{k:'beer',e:'🍻',kind:'spawn'},{k:'hole',e:'🕳️',kind:'spawn'},{k:'chili',e:'🌶️',kind:'spawn'},{k:'shrink',e:'🌀',kind:'instant'} ];
  powerBtn.addEventListener('click', ()=>{ if(!Game.inPlay||!Game.powerReady) return; const pick=bag[Math.floor(Math.random()*bag.length)]; iconSpan.textContent=pick.e; if(pick.kind==='spawn') spawn(pick.k,12); else if(pick.k==='shrink') triggerShrink(); else if(pick.k==='bomb') triggerBombSingle(); resetPower(); });

  /* ===== Round ===== */
  function startGame(){
    const rName=nameRed.value.trim()||STR.red, bName=nameBlue.value.trim()||STR.blue;
    const br=curRect(); const m=Math.min(br.w,br.h)*0.15;
    const rp=()=>({x:clamp(br.x+Math.random()*br.w,br.x+m,br.x+br.w-m), y:clamp(br.y+Math.random()*br.h,br.y+m,br.y+br.h-m)});
    let a=rp(), b=rp(); let tries=0; while(Math.hypot(a.x-b.x)<160 && tries++<30) b=rp();
    Game.red=mkPlayer(a.x,a.y,RED_C, redSrc.img, rName);
    Game.blue=mkPlayer(b.x,b.y,BLUE_C, blueSrc.img, bName);

    Game.items.length=0; Game.fx.length=0; schedule(ItemType.Gear,600,2500); schedule(ItemType.Heart,1200,2500);
    Game.inPlay=true; Game.t0=performance.now(); Game.last=Game.t0; fieldScale=1; shrinkTimeline=null;
    setPowerReady(true); Game.cdLeft=0; powerBtn.style.display='flex';
    dotRed.style.backgroundImage=`url(${redSrc.url})`; dotBlue.style.backgroundImage=`url(${blueSrc.url})`;
    setup.style.display='none'; requestAnimationFrame(loop);
  }
  function endRound(){
    if(!Game.inPlay) return; Game.inPlay=false; powerBtn.style.display='none';
    let tie=false, redWin=false;
    if(Game.red.hp<=0 && Game.blue.hp<=0) tie=true; else redWin = Game.blue.hp<=0;
    if(tie){ postAva.style.backgroundImage=''; postName.textContent = isZH? '平局' : 'TIE'; postTag.textContent = isZH? '平局' : 'TIE'; postTag.classList.add('tieTag'); }
    else { const winSrc=redWin? redSrc.url : blueSrc.url; const winName=redWin? Game.red.name : Game.blue.name; postAva.style.backgroundImage=`url(${winSrc||''})`; postName.textContent=winName; postTag.textContent = isZH? '胜利' : 'WIN'; postTag.classList.remove('tieTag'); }
    post.style.display='flex';
  }
  btnStart.addEventListener('click', startGame);
  btnAgain.addEventListener('click', ()=>{ post.style.display='none'; startGame(); });
  btnBack.addEventListener('click', ()=>{ post.style.display='none'; setup.style.display='flex'; });

  /* ===== Loop ===== */
  function loop(t){
    const dt=Math.min(0.033,(t-Game.last)/1000); Game.last=t;
    updateShrink(t);
    ctx.clearRect(0,0,W,H); drawField();

    // items
    updateItems(dt); for(const it of Game.items){ if(it.alive) drawItem(it); }

    // players
    const R=Game.red, B=Game.blue; if(!Game.inPlay) return;
    function drawOne(p,color){
      if(isHidden(p)){ holeFx(p); return; }
      // move
      // (movement happens outside)
      // visuals
      speedFx(p); weakFx(p); freezeFx(p); reflectFx(p);
      ring(p.x,p.y,p.r,color);
      if(p.saw) sawFx(p.x,p.y,p.r);
      if(nowT()<p.shieldEnd) dashed(p.x,p.y,p.r,'#74f2ff');
      drawAvatar(p.x,p.y,p.r,p.avatar); starFx(p);
    }
    // physics & pickups
    checkHoleExit(R); checkHoleExit(B);
    stepPlayer(R,dt); stepPlayer(B,dt); collideBalls(R,B);
    for(const it of [...Game.items]) tryPickup(R,it);
    for(const it of [...Game.items]) tryPickup(B,it);

    drawOne(R,RED_C); drawOne(B,BLUE_C);
    drawFx();

    // HUD/power/time
    timerEl.textContent = fmt((performance.now()-Game.t0)/1000);
    updatePower(dt);
    refreshHUD();

    if(R.hp<=0 || B.hp<=0){ endRound(); return; }
    requestAnimationFrame(loop);
  }

  /* ===== init ===== */
  refreshHUD(); validateStart();
})();
</script>
</body>
</html>
